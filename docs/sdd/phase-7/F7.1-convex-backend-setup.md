# F7.1 Convex Backend Setup SDD

## Metadata
- Feature: F7.1 Convex Backend Setup
- Phase: 7
- Status: Complete
- Owner: Web App
- Updated: 2026-02-16

## Goals
- Wire ConvexProvider into web app root with graceful fallback for demo/offline mode.
- Create anonymous session management for vote tracking without authentication.
- Add rate-limited feature submission mutation (5 per session per hour).
- Add admin mutations for status updates, soft-delete, and search.
- Add roadmap CRUD mutations with feature-to-roadmap linking.
- Provide local-only fallback hook for demo mode when VITE_CONVEX_URL is unset.

## Architecture

### ConvexProvider Integration (`src/components/ConvexClientProvider.tsx`)
- Creates `ConvexReactClient` from `VITE_CONVEX_URL` environment variable
- Wraps children with `<ConvexProvider>` when URL is configured
- Falls back to rendering children directly (no provider) for demo/offline mode
- Integrated at root level in `main.tsx`, wrapping BrowserRouter and all providers

### Session Management (`src/lib/convexClient.ts`)
- `createConvexClient()` returns client or null based on env config
- `getSessionId()` creates and persists anonymous UUID in localStorage
- Session ID used for vote tracking and rate limiting

### Backend Functions (`convex/features.ts` additions)
- `submitFeatureRateLimited` - Rate-limited submission (5/hour per session)
- `getFeatureStats` - Aggregated counts by status and total votes
- `updateFeatureStatus` - Admin status update with notes and target version
- `deleteFeature` - Soft-delete via isPublic flag
- `searchFeatures` - Text search across title and description

### Roadmap Functions (`convex/roadmap.ts`)
- `getRoadmapGrouped` - Items grouped by status (planned/in_progress/completed)
- `getRoadmapStats` - Count of items per status
- `createRoadmapItem` - New roadmap entry with priority and quarter
- `updateRoadmapItem` - Partial updates to roadmap fields
- `linkFeatureToRoadmap` - Associate feature requests to roadmap items

### Local Fallback Hook (`src/hooks/useConvexFeatures.ts`)
- `useLocalFeatureRequests()` - Full feature request state management with mock data
- `isConvexConfigured()` - Check if Convex URL is set
- Provides submitFeature, voteOnFeature, getVoteStatus locally
- Used by pages when Convex is not deployed

## Testing Plan
- Unit: ConvexClientProvider renders children when no URL configured
- Unit: getSessionId returns consistent UUID across calls
- Unit: useLocalFeatureRequests handles vote toggling correctly
- Integration: Feature submission respects rate limit in Convex
- Integration: Soft-delete hides features from public queries
- Integration: Roadmap CRUD creates and updates items correctly
