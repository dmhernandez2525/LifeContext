# F5.2 Voice-Docs Backend SDD

## Metadata
- Feature: F5.2 Voice-Docs Backend
- Phase: 5
- Status: In Progress
- Owner: Web + Convex
- Updated: 2026-02-15

## Goals
- Add Convex-backed persistence for voice-docs conversations.
- Add Claude-powered backend responses with LifeContext-specific system prompt.
- Add context awareness based on current app section.
- Add response caching to reduce repeated model calls.
- Add conversation memory for multi-turn continuity.
- Add question frequency analytics.
- Add per-session rate limiting.
- Add reliable fallback responses when model access fails.
- Add conversation summarization endpoint.
- Add webhook emission for response-quality monitoring.

## Data Model
- `voiceDocConversations`
  - Session scope, active app context, timestamps.
- `voiceDocMessages`
  - Conversation messages with role and metadata.
- `voiceDocCache`
  - Prompt hash key, cached response, TTL.
- `voiceDocQuestionAnalytics`
  - Normalized question frequency and last context.
- `voiceDocRateLimits`
  - Session window counters.

## Backend API Surface (Convex)
- Mutations
  - `voiceDocs.startConversation`
  - `voiceDocs.recordFeedback`
- Queries
  - `voiceDocs.getConversation`
  - `voiceDocs.getMostAskedQuestions`
- Actions
  - `voiceDocs.respond`
  - `voiceDocs.summarizeConversation`

## Response Flow
1. Validate rate limit for session.
2. Check cache by normalized question + context.
3. If cache miss, load recent conversation memory.
4. Call Anthropic Messages API.
5. On failure, return contextual fallback response.
6. Persist user and assistant messages.
7. Update analytics counters.
8. Write response to cache.
9. Emit webhook event if configured.

## Configuration
- `ANTHROPIC_API_KEY` (server env)
- `VOICE_DOCS_WEBHOOK_URL` (optional)
- `VITE_CONVEX_URL` (web client)

## Security and Privacy
- Never store plaintext keys in client state.
- Keep assistant memory scoped to conversation/session.
- Avoid logging sensitive user content.
- Keep zero-knowledge language and boundaries intact.

## Testing Plan
- Verify cache hit behavior for repeated questions.
- Verify fallback response when Anthropic key is unavailable.
- Verify rate-limiting enforcement within active window.
- Verify conversation persistence and message ordering.
- Verify summary endpoint returns structured output.
