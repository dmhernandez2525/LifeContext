# F6.1 Mobile Authentication SDD

## Metadata
- Feature: F6.1 Mobile Authentication
- Phase: 6
- Status: Complete
- Owner: Mobile App
- Updated: 2026-02-15

## Goals
- Implement passcode-based login with visual pin-dot feedback.
- Add biometric unlock via expo-local-authentication (Face ID, Touch ID, fingerprint).
- Secure credential storage using expo-secure-store with device-only keychain access.
- Add configurable auto-lock timeout with background/foreground detection.
- Support fully offline authentication with no network dependency.
- Implement passcode recovery via email + backup code.
- Add "Lock Now" home screen quick action.
- Protect against brute-force attacks with exponential backoff (4s base, 5 min cap).
- Track session activity with device labels and timestamps.
- Support multi-device session listing and remote revocation.

## Architecture

### Security Layer (`apps/mobile/src/security/`)
- `authTypes.ts` - Type definitions for credentials, sessions, activity logs, rate limits.
- `authCrypto.ts` - Salt generation (expo-crypto), SHA256 hashing, token generation.
- `authSecureStore.ts` - expo-secure-store wrapper for credential and token persistence.
- `authDevice.ts` - Device identification using expo-constants and Platform API.
- `authLocalStore.ts` - MMKV-backed session, activity, and rate-limit persistence.
- `authService.ts` - Orchestration layer: credential registration, passcode verification, biometric auth, recovery, session management, activity logging.

### UI Components (`apps/mobile/src/components/security/`)
- `LockScreen.tsx` - Full-screen lock with passcode pad, biometric prompt, recovery access, and lockout countdown.
- `PasscodePad.tsx` - 12-button numeric keypad with visual dot feedback.
- `PasscodeRecoverySheet.tsx` - Bottom sheet modal for email + backup code recovery.
- `AppLockProvider.tsx` - App-level provider that detects foreground/background transitions and triggers lock after idle timeout.

### Store (`apps/mobile/src/store/`)
- `useSecurityStore.ts` - Zustand store with MMKV persistence for lock state, biometric preference, and timeout configuration.

### Integration Points
- `apps/mobile/app/onboarding.tsx` - Credential setup during initial registration.
- `apps/mobile/app/settings/security.tsx` - Full security settings UI with session management, biometric toggle, timeout selector, and activity log.
- `apps/mobile/src/lib/quickActions.ts` - "Lock Now" home screen quick action.

## Security Model
- Passcodes are never stored in plaintext; only salt + SHA256 hash.
- Credentials stored in device-only keychain via expo-secure-store.
- Backup codes are 16-char uppercase hex tokens, hashed before storage.
- Brute-force protection: exponential backoff starting at 4s, doubling per attempt, capped at 5 minutes.
- Activity log capped at 200 entries to prevent unbounded storage growth.
- Sessions capped at 25 per device.

## Storage Keys
- `lcc-auth-credential` (secure store)
- `lcc-auth-active-token` (secure store)
- `lcc-auth-sessions` (MMKV)
- `lcc-auth-activity` (MMKV)
- `lcc-auth-rate-limit` (MMKV)
- `lcc-security` (Zustand/MMKV)

## Testing Plan
- Unit: passcode hashing and verification
- Unit: exponential backoff calculation
- Unit: session creation, listing, and revocation
- Unit: recovery flow validation
- Integration: biometric auth flow (mocked)
- Integration: auto-lock on background/foreground transition
- Integration: brute-force lockout enforcement
- E2E: lock screen passcode entry and unlock
- E2E: recovery sheet submission and passcode reset
